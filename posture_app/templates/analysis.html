<!-- posture_app/templates/analysis.html -->
{% extends 'base.html' %}

{% block title %}Analyse en Temps Réel - PostureMonitor{% endblock %}

{% block extra_css %}
<style>
    .video-container {
        position: relative;
        background: #000;
        border-radius: var(--radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-lg);
    }

    #videoFeed {
        width: 100%;
        height: auto;
        display: none;
        /* Cacher la vidéo originale */
    }

    #skeletonCanvas {
        width: 100%;
        height: auto;
        display: block;
        background: #111827;
    }

    .detection-status {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.75);
        backdrop-filter: blur(4px);
        color: white;
        padding: 8px 16px;
        border-radius: 50px;
        font-size: 0.85rem;
        font-weight: 600;
        z-index: 10;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .detection-status.active {
        background: rgba(16, 185, 129, 0.9);
        box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
    }

    .controls {
        background: white;
        border-radius: var(--radius-lg);
        padding: 30px;
        box-shadow: var(--shadow-md);
        height: 100%;
        border: 1px solid var(--border-color);
    }

    .metric-box {
        background: var(--bg-body);
        border-radius: var(--radius-md);
        padding: 15px;
        margin-bottom: 15px;
        border-left: 4px solid var(--text-muted);
        transition: all 0.3s;
    }

    .metric-box.good {
        border-left-color: var(--secondary-color);
        background: linear-gradient(to right, rgba(16, 185, 129, 0.05), transparent);
    }

    .metric-box.bad {
        border-left-color: var(--danger-color);
        background: linear-gradient(to right, rgba(239, 68, 68, 0.05), transparent);
        animation: shake 0.5s;
    }

    @keyframes shake {

        0%,
        100% {
            transform: translateX(0);
        }

        25% {
            transform: translateX(-5px);
        }

        75% {
            transform: translateX(5px);
        }
    }

    .metric-value {
        font-size: 1.5rem;
        font-weight: 800;
        color: var(--text-main);
    }

    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 10px;
    }

    .status-indicator.good {
        background-color: var(--secondary-color);
        box-shadow: 0 0 10px var(--secondary-color);
    }

    .status-indicator.bad {
        background-color: var(--danger-color);
        box-shadow: 0 0 10px var(--danger-color);
        animation: pulse 1s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
            transform: scale(1);
        }

        50% {
            opacity: 0.5;
            transform: scale(1.2);
        }
    }

    .alert-box {
        background: linear-gradient(135deg, var(--danger-color), #f87171);
        color: white;
        border-radius: var(--radius-md);
        padding: 20px;
        margin-top: 20px;
        display: none;
        box-shadow: var(--shadow-md);
    }

    .alert-box.show {
        display: block;
        animation: slideIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes slideIn {
        from {
            transform: translateY(-20px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .correction-tips {
        background: white;
        border-radius: var(--radius-lg);
        padding: 20px;
        box-shadow: var(--shadow-sm);
        margin-top: 20px;
        border: 1px solid var(--border-color);
    }

    .tip-item {
        padding: 15px;
        margin: 10px 0;
        border-radius: var(--radius-md);
        display: flex;
        align-items: start;
        gap: 15px;
        transition: all 0.3s;
        border: 1px solid transparent;
    }

    .tip-item.active {
        background: rgba(245, 158, 11, 0.1);
        border-color: rgba(245, 158, 11, 0.2);
        animation: highlight 0.5s;
    }

    @keyframes highlight {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.02);
        }

        100% {
            transform: scale(1);
        }
    }

    .tip-icon {
        font-size: 1.5rem;
        min-width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(79, 70, 229, 0.1);
        color: var(--primary-color);
        border-radius: 50%;
    }

    .tip-item:hover {
        background: var(--bg-body);
        transform: translateX(5px);
    }

    .tip-content h6 {
        margin: 0 0 4px 0;
        color: var(--text-main);
        font-weight: 600;
    }

    .tip-content p {
        margin: 0;
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    .stats-box {
        background: white;
        border-radius: var(--radius-lg);
        padding: 20px;
        box-shadow: var(--shadow-sm);
        margin-top: 20px;
        border: 1px solid var(--border-color);
    }

    .btn-start {
        background: linear-gradient(135deg, var(--secondary-color), #059669);
        color: white;
        border: none;
        padding: 15px 40px;
        border-radius: 50px;
        font-size: 1.1rem;
        font-weight: 600;
        box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);
        transition: all 0.3s;
    }

    .btn-start:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.4);
        color: white;
    }

    .btn-stop {
        background: linear-gradient(135deg, var(--danger-color), #dc2626);
        color: white;
        border: none;
        padding: 15px 40px;
        border-radius: 50px;
        font-size: 1.1rem;
        font-weight: 600;
        box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);
        transition: all 0.3s;
    }

    .btn-stop:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(239, 68, 68, 0.4);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4 animate__animated animate__fadeInDown">
        <div class="col-12 text-center">
            <h2 class="fw-bold mb-2">Analyse Posturale en Temps Réel</h2>
            <p class="text-muted">Utilisez votre webcam pour analyser et corriger votre posture instantanément</p>
        </div>
    </div>

    <div class="row g-4">
        <!-- Colonne gauche : Vidéo avec squelette -->
        <div class="col-lg-8">
            <div class="card card-custom border-0 shadow-lg animate__animated animate__fadeInLeft">
                <div class="card-body p-0">
                    <div class="video-container">
                        <video id="videoFeed" autoplay playsinline></video>
                        <canvas id="skeletonCanvas"></canvas>
                        <canvas id="canvasOverlay" style="display:none;"></canvas>
                        <div class="detection-status" id="detectionStatus">
                            <i class="fas fa-circle"></i> En attente
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alertes -->
            <div class="alert-box animate__animated animate__shakeX" id="alertBox">
                <h4 class="mb-0 fw-bold">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="alertMessage">Corrigez votre posture !</span>
                </h4>
                <p class="mb-0 mt-2 opacity-75">
                    <small id="alertDuration">Mauvaise posture depuis 10s</small>
                </p>
            </div>

            <!-- Conseils de correction -->
            <div class="correction-tips animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
                <h5 class="mb-3 fw-bold d-flex align-items-center">
                    <i class="fas fa-lightbulb text-warning me-2"></i> Conseils de correction
                </h5>
                <div id="tipsContainer">
                    <div class="tip-item" id="tipNeck">
                        <div class="tip-icon"><i class="fas fa-head-side-virus"></i></div>
                        <div class="tip-content">
                            <h6>Position de la tête</h6>
                            <p>Gardez votre tête droite, alignée avec votre colonne vertébrale. Imaginez un fil qui tire
                                le
                                sommet de votre tête vers le plafond.</p>
                        </div>
                    </div>

                    <div class="tip-item" id="tipBack">
                        <div class="tip-icon"><i class="fas fa-user"></i></div>
                        <div class="tip-content">
                            <h6>Posture du dos</h6>
                            <p>Gardez votre dos droit et vos épaules en arrière. Ne vous affalez pas sur votre chaise.
                                Utilisez un support lombaire si nécessaire.</p>
                        </div>
                    </div>

                    <div class="tip-item" id="tipShoulders">
                        <div class="tip-icon"><i class="fas fa-balance-scale"></i></div>
                        <div class="tip-content">
                            <h6>Alignement des épaules</h6>
                            <p>Vos épaules doivent être au même niveau et détendues. Évitez de les hausser ou de pencher
                                d'un côté.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Colonne droite : Contrôles et Statistiques -->
        <div class="col-lg-4">
            <!-- Contrôles -->
            <div class="controls animate__animated animate__fadeInRight">
                <h4 class="mb-4 fw-bold">
                    <i class="fas fa-sliders-h text-primary me-2"></i> Contrôles
                </h4>

                <div class="text-center mb-4">
                    <button id="startBtn" class="btn btn-start w-100 mb-2 shadow-sm" onclick="startAnalysis()">
                        <i class="fas fa-play me-2"></i> Démarrer l'analyse
                    </button>
                    <button id="stopBtn" class="btn btn-stop w-100 mb-2 shadow-sm" onclick="stopAnalysis()"
                        style="display:none;">
                        <i class="fas fa-stop me-2"></i> Arrêter l'analyse
                    </button>
                    <a href="{% url 'posture_guide' %}" class="btn btn-outline-secondary w-100 mt-2">
                        <i class="fas fa-book-open me-2"></i> Consulter le guide de posture
                    </a>
                </div>

                <hr class="opacity-10 my-4">

                <!-- Statut actuel -->
                <div class="mb-4">
                    <h5 class="fw-bold mb-3">Statut</h5>
                    <div id="statusDisplay" class="p-3 bg-light rounded-3 d-flex align-items-center">
                        <span class="status-indicator good" id="statusIndicator"></span>
                        <span id="statusText" class="fw-medium">En attente...</span>
                    </div>
                </div>

                <!-- Métriques -->
                <h5 class="fw-bold mb-3">Métriques en direct</h5>
                <div class="metric-box good" id="neckMetric">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted fw-bold text-uppercase">Angle Cou</small>
                            <div class="metric-value my-1" id="neckAngle">--°</div>
                            <small class="text-muted text-xs">Optimal: &lt; 15°</small>
                        </div>
                        <i class="fas fa-check-circle fa-2x text-success" id="neckIcon"></i>
                    </div>
                </div>

                <div class="metric-box good" id="backMetric">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted fw-bold text-uppercase">Angle Dos</small>
                            <div class="metric-value my-1" id="backAngle">--°</div>
                            <small class="text-muted text-xs">Optimal: &gt; 160°</small>
                        </div>
                        <i class="fas fa-check-circle fa-2x text-success" id="backIcon"></i>
                    </div>
                </div>

                <div class="metric-box good" id="shoulderMetric">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted fw-bold text-uppercase">Épaules</small>
                            <div class="metric-value my-1" id="shoulderDiff">--</div>
                            <small class="text-muted text-xs">Optimal: &lt; 15</small>
                        </div>
                        <i class="fas fa-check-circle fa-2x text-success" id="shoulderIcon"></i>
                    </div>
                </div>


                <div class="stats-box animate__animated animate__fadeInUp" style="animation-delay: 0.3s;">
                    <h5 class="mb-3 fw-bold">
                        <i class="fas fa-chart-line text-primary me-2"></i> Statistiques
                    </h5>

                    <div class="row text-center g-2">
                        <div class="col-6 mb-2">
                            <div class="p-2 bg-light rounded-3">
                                <small class="text-muted d-block mb-1">Durée</small>
                                <div class="fw-bold" id="sessionDuration">00:00</div>
                            </div>
                        </div>
                        <div class="col-6 mb-2">
                            <div class="p-2 bg-light rounded-3">
                                <small class="text-muted d-block mb-1">Score</small>
                                <div class="fw-bold text-success" id="sessionScore">100%</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 bg-light rounded-3">
                                <small class="text-muted d-block mb-1">Alertes</small>
                                <div class="fw-bold text-danger" id="alertCount">0</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 bg-light rounded-3">
                                <small class="text-muted d-block mb-1">Mauvaise</small>
                                <div class="fw-bold" id="badPostureTime">0s</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistiques de session -->

        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Variables globales
    let videoStream = null;
    let analysisInterval = null;
    let sessionId = null;
    let sessionStartTime = null;
    let badPostureStartTime = null;
    let totalBadPostureTime = 0;
    let alertCount = 0;
    let isAnalyzing = false;
    let skeletonCanvas = null;
    let skeletonCtx = null;

    // Initialiser le canvas pour le squelette
    function initSkeletonCanvas() {
        skeletonCanvas = document.getElementById('skeletonCanvas');
        skeletonCtx = skeletonCanvas.getContext('2d');
    }

    // Fonction pour démarrer l'analyse
    async function startAnalysis() {
        try {
            initSkeletonCanvas();

            videoStream = await navigator.mediaDevices.getUserMedia({
                video: { width: 640, height: 480 }
            });

            const video = document.getElementById('videoFeed');
            video.srcObject = videoStream;

            video.onloadedmetadata = () => {
                skeletonCanvas.width = video.videoWidth;
                skeletonCanvas.height = video.videoHeight;
            };

            const response = await fetch('/api/session/start/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            if (!response.ok) {
                throw new Error('Erreur de démarrage de session: ' + response.status);
            }

            const data = await response.json();
            if (!data.success || !data.session_id) {
                throw new Error('Réponse invalide de l’API de session');
            }

            sessionId = data.session_id;
            sessionStartTime = Date.now();
            isAnalyzing = true;

            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';

            document.getElementById('detectionStatus').innerHTML =
                '<i class="fas fa-circle"></i> Analyse en cours...';
            document.getElementById('detectionStatus').classList.add('active');

            analysisInterval = setInterval(processFrame, 200);

            setInterval(updateTimer, 1000);

        } catch (error) {
            console.error('Erreur lors du démarrage de l’analyse:', error);
            alert('Impossible d\'accéder à la webcam ou de démarrer la session. Vérifiez les permissions et la console.');
        }
    }

    // Fonction pour arrêter l'analyse
    async function stopAnalysis() {
        isAnalyzing = false;

        // Arrêter la webcam
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
        }

        // Arrêter l'analyse
        if (analysisInterval) {
            clearInterval(analysisInterval);
        }

        // Effacer le canvas
        if (skeletonCtx) {
            skeletonCtx.clearRect(0, 0, skeletonCanvas.width, skeletonCanvas.height);
        }

        // Terminer la session
        if (sessionId) {
            const sessionDuration = (Date.now() - sessionStartTime) / 1000;
            const badPosturePercentage = (totalBadPostureTime / sessionDuration) * 100;

            await fetch(`/api/session/${sessionId}/end/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    bad_posture_time: totalBadPostureTime,
                    bad_posture_percentage: badPosturePercentage,
                    alert_count: alertCount
                })
            });

            // Rediriger vers le dashboard
            window.location.href = '/dashboard/';
        }

        // Réinitialiser les boutons
        document.getElementById('startBtn').style.display = 'inline-block';
        document.getElementById('stopBtn').style.display = 'none';
        document.getElementById('detectionStatus').classList.remove('active');
    }

    // Fonction pour traiter une frame
    async function processFrame() {
        if (!isAnalyzing) return;

        const video = document.getElementById('videoFeed');
        const canvas = document.getElementById('canvasOverlay');

        // Capturer la frame
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);

        // Convertir en base64
        const imageData = canvas.toDataURL('image/jpeg', 0.8);

        // Envoyer au serveur pour analyse
        try {
            const response = await fetch('/api/frame/process/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    frame: imageData
                })
            });

            if (!response.ok) {
                console.error('Réponse HTTP invalide pour l’analyse:', response.status);
                document.getElementById('statusText').textContent = 'Erreur d’analyse (HTTP ' + response.status + ')';
                document.getElementById('detectionStatus').classList.remove('active');
                return;
            }

            const data = await response.json();

            if (!data.success) {
                console.error('Erreur de traitement API:', data.error || data.message || 'Erreur inconnue');
                document.getElementById('statusText').textContent = 'Erreur d’analyse, voir la console.';
                document.getElementById('detectionStatus').classList.remove('active');
                return;
            }

            if (data.result && data.result.detected) {
                updateUI(data.result);

                if (data.result.image) {
                    drawSkeletonImage(data.result.image);
                }

                document.getElementById('detectionStatus').innerHTML =
                    '<i class="fas fa-circle"></i> Posture détectée';
            } else {
                document.getElementById('statusText').textContent = 'Personne non détectée';
                document.getElementById('detectionStatus').innerHTML =
                    '<i class="fas fa-circle"></i> Positionnez-vous face à la caméra';

                if (skeletonCtx) {
                    skeletonCtx.clearRect(0, 0, skeletonCanvas.width, skeletonCanvas.height);
                    skeletonCtx.drawImage(video, 0, 0, skeletonCanvas.width, skeletonCanvas.height);
                }
            }
        } catch (error) {
            console.error('Erreur de traitement:', error);
            document.getElementById('statusText').textContent = 'Erreur d’analyse, voir la console.';
            document.getElementById('detectionStatus').classList.remove('active');
        }
    }

    // Fonction pour dessiner l'image avec le squelette
    function drawSkeletonImage(imageDataUrl) {
        const img = new Image();
        img.onload = function () {
            // Dessiner l'image avec le squelette sur le canvas
            skeletonCtx.drawImage(img, 0, 0, skeletonCanvas.width, skeletonCanvas.height);
        };
        img.src = imageDataUrl;
    }

    // Fonction pour mettre à jour l'interface
    function updateUI(result) {
        // Statut
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');

        if (result.is_good_posture) {
            statusIndicator.className = 'status-indicator good';
            statusText.textContent = 'Posture correcte';
            document.getElementById('alertBox').classList.remove('show');
            badPostureStartTime = null;

            // Désactiver tous les conseils
            resetTips();
        } else {
            statusIndicator.className = 'status-indicator bad';
            statusText.textContent = 'Mauvaise posture';

            // Activer les conseils correspondants
            updateTips(result);

            // Gérer l'alerte
            if (!badPostureStartTime) {
                badPostureStartTime = Date.now();
            } else {
                const duration = (Date.now() - badPostureStartTime) / 1000;
                if (duration >= 10) {
                    document.getElementById('alertBox').classList.add('show');
                    document.getElementById('alertDuration').textContent =
                        `Mauvaise posture depuis ${Math.round(duration)}s`;

                    // Incrémenter le compteur d'alertes toutes les 10 secondes
                    if (Math.round(duration) % 10 === 0) {
                        alertCount++;
                        document.getElementById('alertCount').textContent = alertCount;
                        playAlertSound();
                    }

                    totalBadPostureTime = duration;
                    document.getElementById('badPostureTime').textContent = Math.round(duration) + 's';
                }
            }
        }

        // Métriques
        updateMetric('neck', result.neck_angle, result.neck_ok);
        updateMetric('back', result.back_angle, result.back_ok);
        updateMetric('shoulder', result.shoulder_diff, result.shoulders_ok);
    }

    // Fonction pour mettre à jour les conseils
    function updateTips(result) {
        resetTips();

        if (!result.neck_ok) {
            document.getElementById('tipNeck').classList.add('active');
        }
        if (!result.back_ok) {
            document.getElementById('tipBack').classList.add('active');
        }
        if (!result.shoulders_ok) {
            document.getElementById('tipShoulders').classList.add('active');
        }
    }

    // Fonction pour réinitialiser les conseils
    function resetTips() {
        document.getElementById('tipNeck').classList.remove('active');
        document.getElementById('tipBack').classList.remove('active');
        document.getElementById('tipShoulders').classList.remove('active');
    }

    // Fonction pour mettre à jour une métrique
    function updateMetric(type, value, isOk) {
        const metricBox = document.getElementById(`${type}Metric`);
        const angleDisplay = document.getElementById(`${type}Angle`) ||
            document.getElementById(`${type}Diff`);
        const icon = document.getElementById(`${type}Icon`);

        angleDisplay.textContent = type === 'shoulder' ?
            value.toFixed(1) : Math.round(value) + '°';

        if (isOk) {
            metricBox.classList.remove('bad');
            metricBox.classList.add('good');
            icon.className = 'fas fa-check-circle fa-2x text-success';
        } else {
            metricBox.classList.remove('good');
            metricBox.classList.add('bad');
            icon.className = 'fas fa-times-circle fa-2x text-danger';
        }
    }

    // Fonction pour mettre à jour le timer
    function updateTimer() {
        if (!isAnalyzing || !sessionStartTime) return;

        const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;

        document.getElementById('sessionDuration').textContent =
            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

        // Mettre à jour le score
        const score = elapsed > 0 ? 100 - (totalBadPostureTime / elapsed) * 100 : 100;
        document.getElementById('sessionScore').textContent = Math.max(0, Math.round(score)) + '%';
    }

    // Fonction pour jouer un son d'alerte
    function playAlertSound() {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 800;
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        } catch (error) {
            console.log('Audio non disponible');
        }
    }

    // Fonction pour obtenir le cookie CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}